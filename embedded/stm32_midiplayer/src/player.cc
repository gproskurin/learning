#include "player.h"

#include "cmsis_device.h"
#include "lib_stm32.h"

#include <array>


enum instrument_t {
	none,
	sin,
	sq
};
volatile instrument_t g_instrument = none;
instrument_t g_def_instrument = sin;

#define DDS_FREQ 41943
#define DDS_FREQ_MUL_100 4194304 // DDS_FREQ*100 rounded to power of 2, to allow it be multiplied FIXME

const stm32_lib::gpio::gpio_pin_t pin_dac(GPIOA, 4);

const std::array<uint32_t, 12*9> freq100 = {
	1635, 1732, 1835, 1945, 2060, 2183, 2312, 2450, 2596, 2750, 2914, 3087,
	3270, 3465, 3671, 3889, 4120, 4365, 4625, 4900, 5191, 5500, 5827, 6174,
	6541, 6930, 7342, 7778, 8241, 8731, 9250, 9800, 10383, 11000, 11654, 12347,
	13081, 13859, 14683, 15556, 16481, 17461, 18500, 19600, 20765, 22000, 23308, 24694,
	26163, 27718, 29366, 31113, 32963, 34923, 36999, 39200, 41530, 44000, 46616, 49388,
	52325, 55437, 58733, 62225, 65925, 69846, 73999, 78399, 83061, 88000, 93233, 98777,
	104650, 110873, 117466, 124451, 131851, 139691, 147998, 156798, 166122, 176000, 186466, 197553,
	209300, 221746, 234932, 248902, 263702, 279383, 295996, 313596, 332244, 352000, 372931, 395107,
	418601, 443492, 469863, 497803, 527404, 558765, 591991, 627193, 664488, 704000, 745862, 790213
};


typedef uint16_t dds_value_t;

class lookup_square_t {
public:
	static dds_value_t lookup(uint32_t x)
	{
		return (x >> 31) ? std::numeric_limits<dds_value_t>::max() : 0;
	}
};

class lookup_sin3_t {
	static constexpr std::array<dds_value_t, 8> lookup_table{
		32768, 55938, 65535, 55938, 32768, 9597, 0, 9597
	};
public:
	static dds_value_t lookup(uint32_t x)
	{
		return lookup_table[x >> 29];
	}
};

class lookup_sin4_t {
	static constexpr std::array<dds_value_t, 16> lookup_table{
		32768, 45307, 55938, 63041, 65535, 63041, 55938, 45307, 32768, 20228, 9597, 2494, 0, 2494, 9597, 20228
	};
public:
	static dds_value_t lookup(uint32_t x)
	{
		return lookup_table[x >> 28];
	}
};

class lookup_sin5_t {
	static constexpr std::array<dds_value_t, 32> lookup_table{
		32768, 39160, 45307, 50972, 55938, 60013, 63041, 64905,
		65535, 64905, 63041, 60013, 55938, 50972, 45307, 39160,
		32768, 26375, 20228, 14563, 9597, 5522, 2494, 630,
		0, 630, 2494, 5522, 9597, 14563, 20228, 26375
	};
public:
	static dds_value_t lookup(uint32_t x)
	{
		return lookup_table[x >> 27];
	}
};

class lookup_sin10_t {
	static constexpr std::array<dds_value_t, 1024> lookup_table{
		32768, 32969, 33170, 33371, 33572, 33773, 33974, 34174, 34375, 34576, 34777, 34977, 35178, 35378, 35579, 35779,
		35979, 36179, 36379, 36579, 36779, 36978, 37177, 37377, 37575, 37774, 37973, 38171, 38369, 38567, 38765, 38963,
		39160, 39357, 39554, 39751, 39947, 40143, 40339, 40534, 40729, 40924, 41119, 41313, 41507, 41701, 41894, 42087,
		42279, 42472, 42663, 42855, 43046, 43237, 43427, 43617, 43807, 43996, 44184, 44373, 44560, 44748, 44935, 45121,
		45307, 45493, 45678, 45862, 46046, 46230, 46413, 46595, 46777, 46959, 47140, 47320, 47500, 47679, 47858, 48036,
		48214, 48391, 48567, 48743, 48919, 49093, 49267, 49441, 49613, 49785, 49957, 50128, 50298, 50468, 50636, 50805,
		50972, 51139, 51305, 51471, 51635, 51799, 51963, 52125, 52287, 52448, 52609, 52768, 52927, 53085, 53243, 53399,
		53555, 53710, 53864, 54018, 54170, 54322, 54473, 54623, 54773, 54921, 55069, 55216, 55362, 55507, 55652, 55795,
		55938, 56079, 56220, 56360, 56499, 56637, 56775, 56911, 57047, 57181, 57315, 57448, 57579, 57710, 57840, 57969,
		58097, 58224, 58350, 58475, 58600, 58723, 58845, 58966, 59087, 59206, 59324, 59441, 59558, 59673, 59787, 59900,
		60013, 60124, 60234, 60343, 60451, 60558, 60664, 60769, 60873, 60976, 61078, 61178, 61278, 61377, 61474, 61571,
		61666, 61760, 61853, 61945, 62036, 62126, 62215, 62302, 62389, 62474, 62559, 62642, 62724, 62805, 62885, 62963,
		63041, 63117, 63192, 63266, 63339, 63411, 63482, 63551, 63620, 63687, 63753, 63818, 63881, 63944, 64005, 64065,
		64124, 64182, 64238, 64294, 64348, 64401, 64453, 64504, 64553, 64601, 64648, 64694, 64739, 64782, 64825, 64866,
		64905, 64944, 64981, 65018, 65053, 65086, 65119, 65150, 65180, 65209, 65237, 65263, 65289, 65313, 65335, 65357,
		65377, 65396, 65414, 65431, 65446, 65460, 65473, 65485, 65496, 65505, 65513, 65520, 65525, 65529, 65533, 65534,
		65535, 65534, 65533, 65529, 65525, 65520, 65513, 65505, 65496, 65485, 65473, 65460, 65446, 65431, 65414, 65396,
		65377, 65357, 65335, 65313, 65289, 65263, 65237, 65209, 65180, 65150, 65119, 65086, 65053, 65018, 64981, 64944,
		64905, 64866, 64825, 64782, 64739, 64694, 64648, 64601, 64553, 64504, 64453, 64401, 64348, 64294, 64238, 64182,
		64124, 64065, 64005, 63944, 63881, 63818, 63753, 63687, 63620, 63551, 63482, 63411, 63339, 63266, 63192, 63117,
		63041, 62963, 62885, 62805, 62724, 62642, 62559, 62474, 62389, 62302, 62215, 62126, 62036, 61945, 61853, 61760,
		61666, 61571, 61474, 61377, 61278, 61178, 61078, 60976, 60873, 60769, 60664, 60558, 60451, 60343, 60234, 60124,
		60013, 59900, 59787, 59673, 59558, 59441, 59324, 59206, 59087, 58966, 58845, 58723, 58600, 58475, 58350, 58224,
		58097, 57969, 57840, 57710, 57579, 57448, 57315, 57181, 57047, 56911, 56775, 56637, 56499, 56360, 56220, 56079,
		55938, 55795, 55652, 55507, 55362, 55216, 55069, 54921, 54773, 54623, 54473, 54322, 54170, 54018, 53864, 53710,
		53555, 53399, 53243, 53085, 52927, 52768, 52609, 52448, 52287, 52125, 51963, 51799, 51635, 51471, 51305, 51139,
		50972, 50805, 50636, 50468, 50298, 50128, 49957, 49785, 49613, 49441, 49267, 49093, 48919, 48743, 48567, 48391,
		48214, 48036, 47858, 47679, 47500, 47320, 47140, 46959, 46777, 46595, 46413, 46230, 46046, 45862, 45678, 45493,
		45307, 45121, 44935, 44748, 44560, 44373, 44184, 43996, 43807, 43617, 43427, 43237, 43046, 42855, 42663, 42472,
		42279, 42087, 41894, 41701, 41507, 41313, 41119, 40924, 40729, 40534, 40339, 40143, 39947, 39751, 39554, 39357,
		39160, 38963, 38765, 38567, 38369, 38171, 37973, 37774, 37575, 37377, 37177, 36978, 36779, 36579, 36379, 36179,
		35979, 35779, 35579, 35378, 35178, 34977, 34777, 34576, 34375, 34174, 33974, 33773, 33572, 33371, 33170, 32969,
		32768, 32566, 32365, 32164, 31963, 31762, 31561, 31361, 31160, 30959, 30758, 30558, 30357, 30157, 29956, 29756,
		29556, 29356, 29156, 28956, 28756, 28557, 28358, 28158, 27960, 27761, 27562, 27364, 27166, 26968, 26770, 26572,
		26375, 26178, 25981, 25784, 25588, 25392, 25196, 25001, 24806, 24611, 24416, 24222, 24028, 23834, 23641, 23448,
		23256, 23063, 22872, 22680, 22489, 22298, 22108, 21918, 21728, 21539, 21351, 21162, 20975, 20787, 20600, 20414,
		20228, 20042, 19857, 19673, 19489, 19305, 19122, 18940, 18758, 18576, 18395, 18215, 18035, 17856, 17677, 17499,
		17321, 17144, 16968, 16792, 16616, 16442, 16268, 16094, 15922, 15750, 15578, 15407, 15237, 15067, 14899, 14730,
		14563, 14396, 14230, 14064, 13900, 13736, 13572, 13410, 13248, 13087, 12926, 12767, 12608, 12450, 12292, 12136,
		11980, 11825, 11671, 11517, 11365, 11213, 11062, 10912, 10762, 10614, 10466, 10319, 10173, 10028, 9883, 9740,
		9597, 9456, 9315, 9175, 9036, 8898, 8760, 8624, 8488, 8354, 8220, 8087, 7956, 7825, 7695, 7566,
		7438, 7311, 7185, 7060, 6935, 6812, 6690, 6569, 6448, 6329, 6211, 6094, 5977, 5862, 5748, 5635,
		5522, 5411, 5301, 5192, 5084, 4977, 4871, 4766, 4662, 4559, 4457, 4357, 4257, 4158, 4061, 3964,
		3869, 3775, 3682, 3590, 3499, 3409, 3320, 3233, 3146, 3061, 2976, 2893, 2811, 2730, 2650, 2572,
		2494, 2418, 2343, 2269, 2196, 2124, 2053, 1984, 1915, 1848, 1782, 1717, 1654, 1591, 1530, 1470,
		1411, 1353, 1297, 1241, 1187, 1134, 1082, 1031, 982, 934, 887, 841, 796, 753, 710, 669,
		630, 591, 554, 517, 482, 449, 416, 385, 355, 326, 298, 272, 246, 222, 200, 178,
		158, 139, 121, 104, 89, 75, 62, 50, 39, 30, 22, 15, 10, 6, 2, 1,
		0, 1, 2, 6, 10, 15, 22, 30, 39, 50, 62, 75, 89, 104, 121, 139,
		158, 178, 200, 222, 246, 272, 298, 326, 355, 385, 416, 449, 482, 517, 554, 591,
		630, 669, 710, 753, 796, 841, 887, 934, 982, 1031, 1082, 1134, 1187, 1241, 1297, 1353,
		1411, 1470, 1530, 1591, 1654, 1717, 1782, 1848, 1915, 1984, 2053, 2124, 2196, 2269, 2343, 2418,
		2494, 2572, 2650, 2730, 2811, 2893, 2976, 3061, 3146, 3233, 3320, 3409, 3499, 3590, 3682, 3775,
		3869, 3964, 4061, 4158, 4257, 4357, 4457, 4559, 4662, 4766, 4871, 4977, 5084, 5192, 5301, 5411,
		5522, 5635, 5748, 5862, 5977, 6094, 6211, 6329, 6448, 6569, 6690, 6812, 6935, 7060, 7185, 7311,
		7438, 7566, 7695, 7825, 7956, 8087, 8220, 8354, 8488, 8624, 8760, 8898, 9036, 9175, 9315, 9456,
		9597, 9740, 9883, 10028, 10173, 10319, 10466, 10614, 10762, 10912, 11062, 11213, 11365, 11517, 11671, 11825,
		11980, 12136, 12292, 12450, 12608, 12767, 12926, 13087, 13248, 13410, 13572, 13736, 13900, 14064, 14230, 14396,
		14563, 14730, 14899, 15067, 15237, 15407, 15578, 15750, 15922, 16094, 16268, 16442, 16616, 16792, 16968, 17144,
		17321, 17499, 17677, 17856, 18035, 18215, 18395, 18576, 18758, 18940, 19122, 19305, 19489, 19673, 19857, 20042,
		20228, 20414, 20600, 20787, 20975, 21162, 21351, 21539, 21728, 21918, 22108, 22298, 22489, 22680, 22872, 23063,
		23256, 23448, 23641, 23834, 24028, 24222, 24416, 24611, 24806, 25001, 25196, 25392, 25588, 25784, 25981, 26178,
		26375, 26572, 26770, 26968, 27166, 27364, 27562, 27761, 27960, 28158, 28358, 28557, 28756, 28956, 29156, 29356,
		29556, 29756, 29956, 30157, 30357, 30558, 30758, 30959, 31160, 31361, 31561, 31762, 31963, 32164, 32365, 32566
	};
public:
	static dds_value_t lookup(uint32_t x)
	{
		return lookup_table[x >> 22];
	}
};

class lookup_sin12_t {
	static constexpr std::array<dds_value_t, 4096> lookup_table{
		32768, 32818, 32868, 32918, 32969, 33019, 33069, 33119, 33170, 33220, 33270, 33320, 33371, 33421, 33471, 33521, 33572, 33622, 33672, 33722, 33773, 33823, 33873, 33923, 33974, 34024, 34074, 34124, 34174, 34225, 34275, 34325, 34375, 34426, 34476, 34526, 34576, 34626, 34676, 34727, 34777, 34827, 34877, 34927, 34977, 35028, 35078, 35128, 35178, 35228, 35278, 35328, 35378, 35429, 35479, 35529, 35579, 35629, 35679, 35729, 35779, 35829, 35879, 35929, 35979, 36029, 36079, 36129, 36179, 36229, 36279, 36329, 36379, 36429, 36479, 36529, 36579, 36629, 36679, 36729, 36779, 36828, 36878, 36928, 36978, 37028, 37078, 37128, 37177, 37227, 37277, 37327, 37377, 37426, 37476, 37526, 37575, 37625, 37675, 37725, 37774, 37824, 37874, 37923, 37973, 38023, 38072, 38122, 38171, 38221, 38270, 38320, 38369, 38419, 38469, 38518, 38567, 38617, 38666, 38716, 38765, 38815, 38864, 38913, 38963, 39012, 39061, 39111, 39160, 39209, 39259, 39308, 39357, 39406, 39456, 39505, 39554, 39603, 39652, 39701, 39751, 39800, 39849, 39898, 39947, 39996, 40045, 40094, 40143, 40192, 40241, 40290, 40339, 40388, 40436, 40485, 40534, 40583, 40632, 40681, 40729, 40778, 40827, 40876, 40924, 40973, 41022, 41070, 41119, 41167, 41216, 41265, 41313, 41362, 41410, 41459, 41507, 41555, 41604, 41652, 41701, 41749, 41797, 41846, 41894, 41942, 41990, 42039, 42087, 42135, 42183, 42231, 42279, 42327, 42376, 42424, 42472, 42520, 42568, 42616, 42663, 42711, 42759, 42807, 42855, 42903, 42951, 42998, 43046, 43094, 43141, 43189, 43237, 43284, 43332, 43380, 43427, 43475, 43522, 43570, 43617, 43664, 43712, 43759, 43807, 43854, 43901, 43948, 43996, 44043, 44090, 44137, 44184, 44231, 44278, 44326, 44373, 44420, 44467, 44513, 44560, 44607, 44654, 44701, 44748, 44794, 44841, 44888, 44935, 44981, 45028, 45075, 45121, 45168, 45214, 45261, 45307, 45354, 45400, 45446, 45493, 45539, 45585, 45631, 45678, 45724, 45770, 45816, 45862, 45908, 45954, 46000, 46046, 46092, 46138, 46184, 46230, 46276, 46321, 46367, 46413, 46459, 46504, 46550, 46595, 46641, 46686, 46732, 46777, 46823, 46868, 46914, 46959, 47004, 47049, 47095, 47140, 47185, 47230, 47275, 47320, 47365, 47410, 47455, 47500, 47545, 47590, 47635, 47679, 47724, 47769, 47814, 47858, 47903, 47947, 47992, 48036, 48081, 48125, 48170, 48214, 48258, 48303, 48347, 48391, 48435, 48479, 48523, 48567, 48611, 48655, 48699, 48743, 48787, 48831, 48875, 48919, 48962, 49006, 49050, 49093, 49137, 49180, 49224, 49267, 49311, 49354, 49397, 49441, 49484, 49527, 49570, 49613, 49656, 49700, 49743, 49785, 49828, 49871, 49914, 49957, 50000, 50042, 50085, 50128, 50170, 50213, 50256, 50298, 50340, 50383, 50425, 50468, 50510, 50552, 50594, 50636, 50679, 50721, 50763, 50805, 50847, 50888, 50930, 50972, 51014, 51056, 51097, 51139, 51181, 51222, 51264, 51305, 51347, 51388, 51429, 51471, 51512, 51553, 51594, 51635, 51676, 51717, 51758, 51799, 51840, 51881, 51922, 51963, 52003, 52044, 52085, 52125, 52166, 52206, 52247, 52287, 52327, 52368, 52408, 52448, 52488, 52528, 52569, 52609, 52649, 52688, 52728, 52768, 52808, 52848, 52887, 52927, 52967, 53006, 53046, 53085, 53125, 53164, 53203, 53243, 53282, 53321, 53360, 53399, 53438, 53477, 53516, 53555, 53594, 53633, 53671, 53710, 53749, 53787, 53826, 53864, 53903, 53941, 53979, 54018, 54056, 54094, 54132, 54170, 54208, 54246, 54284, 54322, 54360, 54398, 54436, 54473, 54511, 54548, 54586, 54623, 54661, 54698, 54736, 54773, 54810, 54847, 54884, 54921, 54958, 54995, 55032, 55069, 55106, 55143, 55179, 55216, 55253, 55289, 55326, 55362, 55398, 55435, 55471, 55507, 55543, 55579, 55616, 55652, 55687, 55723, 55759, 55795, 55831, 55866, 55902, 55938, 55973, 56009, 56044, 56079, 56115, 56150, 56185, 56220, 56255, 56290, 56325, 56360, 56395, 56430, 56465, 56499, 56534, 56568, 56603, 56637, 56672, 56706, 56741, 56775, 56809, 56843, 56877, 56911, 56945, 56979, 57013, 57047, 57080, 57114, 57148, 57181, 57215, 57248, 57282, 57315, 57348, 57381, 57414, 57448, 57481, 57514, 57546, 57579, 57612, 57645, 57678, 57710, 57743, 57775, 57808, 57840, 57872, 57905, 57937, 57969, 58001, 58033, 58065, 58097, 58129, 58161, 58193, 58224, 58256, 58287, 58319, 58350, 58382, 58413, 58444, 58475, 58507, 58538, 58569, 58600, 58631, 58661, 58692, 58723, 58754, 58784, 58815, 58845, 58875, 58906, 58936, 58966, 58996, 59027, 59057, 59087, 59117, 59146, 59176, 59206, 59236, 59265, 59295, 59324, 59354, 59383, 59412, 59441, 59471, 59500, 59529, 59558, 59587, 59615, 59644, 59673, 59702, 59730, 59759, 59787, 59816, 59844, 59872, 59900, 59929, 59957, 59985, 60013, 60041, 60068, 60096, 60124, 60152, 60179, 60207, 60234, 60261, 60289, 60316, 60343, 60370, 60397, 60424, 60451, 60478, 60505, 60532, 60558, 60585, 60611, 60638, 60664, 60691, 60717, 60743, 60769, 60795, 60821, 60847, 60873, 60899, 60925, 60950, 60976, 61002, 61027, 61052, 61078, 61103, 61128, 61153, 61178, 61203, 61228, 61253, 61278, 61303, 61327, 61352, 61377, 61401, 61426, 61450, 61474, 61498, 61522, 61547, 61571, 61594, 61618, 61642, 61666, 61690, 61713, 61737, 61760, 61783, 61807, 61830, 61853, 61876, 61899, 61922, 61945, 61968, 61991, 62014, 62036, 62059, 62081, 62104, 62126, 62148, 62171, 62193, 62215, 62237, 62259, 62281, 62302, 62324, 62346, 62367, 62389, 62410, 62432, 62453, 62474, 62496, 62517, 62538, 62559, 62580, 62600, 62621, 62642, 62662, 62683, 62703, 62724, 62744, 62764, 62785, 62805, 62825, 62845, 62865, 62885, 62904, 62924, 62944, 62963, 62983, 63002, 63021, 63041, 63060, 63079, 63098, 63117, 63136, 63155, 63174, 63192, 63211, 63230, 63248, 63266, 63285, 63303, 63321, 63339, 63357, 63375, 63393, 63411, 63429, 63447, 63464, 63482, 63499, 63517, 63534, 63551, 63568, 63586, 63603, 63620, 63636, 63653, 63670, 63687, 63703, 63720, 63736, 63753, 63769, 63785, 63801, 63818, 63834, 63849, 63865, 63881, 63897, 63913, 63928, 63944, 63959, 63974, 63990, 64005, 64020, 64035, 64050, 64065, 64080, 64095, 64109, 64124, 64139, 64153, 64167, 64182, 64196, 64210, 64224, 64238, 64252, 64266, 64280, 64294, 64307, 64321, 64335, 64348, 64361, 64375, 64388, 64401, 64414, 64427, 64440, 64453, 64466, 64478, 64491, 64504, 64516, 64528, 64541, 64553, 64565, 64577, 64589, 64601, 64613, 64625, 64637, 64648, 64660, 64671, 64683, 64694, 64705, 64717, 64728, 64739, 64750, 64761, 64772, 64782, 64793, 64804, 64814, 64825, 64835, 64845, 64855, 64866, 64876, 64886, 64896, 64905, 64915, 64925, 64934, 64944, 64953, 64963, 64972, 64981, 64991, 65000, 65009, 65018, 65026, 65035, 65044, 65053, 65061, 65070, 65078, 65086, 65095, 65103, 65111, 65119, 65127, 65135, 65143, 65150, 65158, 65165, 65173, 65180, 65188, 65195, 65202, 65209, 65216, 65223, 65230, 65237, 65244, 65250, 65257, 65263, 65270, 65276, 65282, 65289, 65295, 65301, 65307, 65313, 65318, 65324, 65330, 65335, 65341, 65346, 65352, 65357, 65362, 65367, 65372, 65377, 65382, 65387, 65392, 65396, 65401, 65405, 65410, 65414, 65418, 65423, 65427, 65431, 65435, 65439, 65442, 65446, 65450, 65453, 65457, 65460, 65464, 65467, 65470, 65473, 65476, 65479, 65482, 65485, 65488, 65490, 65493, 65496, 65498, 65500, 65503, 65505, 65507, 65509, 65511, 65513, 65515, 65516, 65518, 65520, 65521, 65523, 65524, 65525, 65526, 65527, 65528, 65529, 65530, 65531, 65532, 65533, 65533, 65534, 65534, 65534, 65535, 65535, 65535,
		65535, 65535, 65535, 65535, 65534, 65534, 65534, 65533, 65533, 65532, 65531, 65530, 65529, 65528, 65527, 65526, 65525, 65524, 65523, 65521, 65520, 65518, 65516, 65515, 65513, 65511, 65509, 65507, 65505, 65503, 65500, 65498, 65496, 65493, 65490, 65488, 65485, 65482, 65479, 65476, 65473, 65470, 65467, 65464, 65460, 65457, 65453, 65450, 65446, 65442, 65439, 65435, 65431, 65427, 65423, 65418, 65414, 65410, 65405, 65401, 65396, 65392, 65387, 65382, 65377, 65372, 65367, 65362, 65357, 65352, 65346, 65341, 65335, 65330, 65324, 65318, 65313, 65307, 65301, 65295, 65289, 65282, 65276, 65270, 65263, 65257, 65250, 65244, 65237, 65230, 65223, 65216, 65209, 65202, 65195, 65188, 65180, 65173, 65165, 65158, 65150, 65143, 65135, 65127, 65119, 65111, 65103, 65095, 65086, 65078, 65070, 65061, 65053, 65044, 65035, 65026, 65018, 65009, 65000, 64991, 64981, 64972, 64963, 64953, 64944, 64934, 64925, 64915, 64905, 64896, 64886, 64876, 64866, 64855, 64845, 64835, 64825, 64814, 64804, 64793, 64782, 64772, 64761, 64750, 64739, 64728, 64717, 64705, 64694, 64683, 64671, 64660, 64648, 64637, 64625, 64613, 64601, 64589, 64577, 64565, 64553, 64541, 64528, 64516, 64504, 64491, 64478, 64466, 64453, 64440, 64427, 64414, 64401, 64388, 64375, 64361, 64348, 64335, 64321, 64307, 64294, 64280, 64266, 64252, 64238, 64224, 64210, 64196, 64182, 64167, 64153, 64139, 64124, 64109, 64095, 64080, 64065, 64050, 64035, 64020, 64005, 63990, 63974, 63959, 63944, 63928, 63913, 63897, 63881, 63865, 63849, 63834, 63818, 63801, 63785, 63769, 63753, 63736, 63720, 63703, 63687, 63670, 63653, 63636, 63620, 63603, 63586, 63568, 63551, 63534, 63517, 63499, 63482, 63464, 63447, 63429, 63411, 63393, 63375, 63357, 63339, 63321, 63303, 63285, 63266, 63248, 63230, 63211, 63192, 63174, 63155, 63136, 63117, 63098, 63079, 63060, 63041, 63021, 63002, 62983, 62963, 62944, 62924, 62904, 62885, 62865, 62845, 62825, 62805, 62785, 62764, 62744, 62724, 62703, 62683, 62662, 62642, 62621, 62600, 62580, 62559, 62538, 62517, 62496, 62474, 62453, 62432, 62410, 62389, 62367, 62346, 62324, 62302, 62281, 62259, 62237, 62215, 62193, 62171, 62148, 62126, 62104, 62081, 62059, 62036, 62014, 61991, 61968, 61945, 61922, 61899, 61876, 61853, 61830, 61807, 61783, 61760, 61737, 61713, 61690, 61666, 61642, 61618, 61594, 61571, 61547, 61522, 61498, 61474, 61450, 61426, 61401, 61377, 61352, 61327, 61303, 61278, 61253, 61228, 61203, 61178, 61153, 61128, 61103, 61078, 61052, 61027, 61002, 60976, 60950, 60925, 60899, 60873, 60847, 60821, 60795, 60769, 60743, 60717, 60691, 60664, 60638, 60611, 60585, 60558, 60532, 60505, 60478, 60451, 60424, 60397, 60370, 60343, 60316, 60289, 60261, 60234, 60207, 60179, 60152, 60124, 60096, 60068, 60041, 60013, 59985, 59957, 59929, 59900, 59872, 59844, 59816, 59787, 59759, 59730, 59702, 59673, 59644, 59615, 59587, 59558, 59529, 59500, 59471, 59441, 59412, 59383, 59354, 59324, 59295, 59265, 59236, 59206, 59176, 59146, 59117, 59087, 59057, 59027, 58996, 58966, 58936, 58906, 58875, 58845, 58815, 58784, 58754, 58723, 58692, 58661, 58631, 58600, 58569, 58538, 58507, 58475, 58444, 58413, 58382, 58350, 58319, 58287, 58256, 58224, 58193, 58161, 58129, 58097, 58065, 58033, 58001, 57969, 57937, 57905, 57872, 57840, 57808, 57775, 57743, 57710, 57678, 57645, 57612, 57579, 57546, 57514, 57481, 57448, 57414, 57381, 57348, 57315, 57282, 57248, 57215, 57181, 57148, 57114, 57080, 57047, 57013, 56979, 56945, 56911, 56877, 56843, 56809, 56775, 56741, 56706, 56672, 56637, 56603, 56568, 56534, 56499, 56465, 56430, 56395, 56360, 56325, 56290, 56255, 56220, 56185, 56150, 56115, 56079, 56044, 56009, 55973, 55938, 55902, 55866, 55831, 55795, 55759, 55723, 55687, 55652, 55616, 55579, 55543, 55507, 55471, 55435, 55398, 55362, 55326, 55289, 55253, 55216, 55179, 55143, 55106, 55069, 55032, 54995, 54958, 54921, 54884, 54847, 54810, 54773, 54736, 54698, 54661, 54623, 54586, 54548, 54511, 54473, 54436, 54398, 54360, 54322, 54284, 54246, 54208, 54170, 54132, 54094, 54056, 54018, 53979, 53941, 53903, 53864, 53826, 53787, 53749, 53710, 53671, 53633, 53594, 53555, 53516, 53477, 53438, 53399, 53360, 53321, 53282, 53243, 53203, 53164, 53125, 53085, 53046, 53006, 52967, 52927, 52887, 52848, 52808, 52768, 52728, 52688, 52649, 52609, 52569, 52528, 52488, 52448, 52408, 52368, 52327, 52287, 52247, 52206, 52166, 52125, 52085, 52044, 52003, 51963, 51922, 51881, 51840, 51799, 51758, 51717, 51676, 51635, 51594, 51553, 51512, 51471, 51429, 51388, 51347, 51305, 51264, 51222, 51181, 51139, 51097, 51056, 51014, 50972, 50930, 50888, 50847, 50805, 50763, 50721, 50679, 50636, 50594, 50552, 50510, 50468, 50425, 50383, 50340, 50298, 50256, 50213, 50170, 50128, 50085, 50042, 50000, 49957, 49914, 49871, 49828, 49785, 49743, 49700, 49656, 49613, 49570, 49527, 49484, 49441, 49397, 49354, 49311, 49267, 49224, 49180, 49137, 49093, 49050, 49006, 48962, 48919, 48875, 48831, 48787, 48743, 48699, 48655, 48611, 48567, 48523, 48479, 48435, 48391, 48347, 48303, 48258, 48214, 48170, 48125, 48081, 48036, 47992, 47947, 47903, 47858, 47814, 47769, 47724, 47679, 47635, 47590, 47545, 47500, 47455, 47410, 47365, 47320, 47275, 47230, 47185, 47140, 47095, 47049, 47004, 46959, 46914, 46868, 46823, 46777, 46732, 46686, 46641, 46595, 46550, 46504, 46459, 46413, 46367, 46321, 46276, 46230, 46184, 46138, 46092, 46046, 46000, 45954, 45908, 45862, 45816, 45770, 45724, 45678, 45631, 45585, 45539, 45493, 45446, 45400, 45354, 45307, 45261, 45214, 45168, 45121, 45075, 45028, 44981, 44935, 44888, 44841, 44794, 44748, 44701, 44654, 44607, 44560, 44513, 44467, 44420, 44373, 44326, 44278, 44231, 44184, 44137, 44090, 44043, 43996, 43948, 43901, 43854, 43807, 43759, 43712, 43664, 43617, 43570, 43522, 43475, 43427, 43380, 43332, 43284, 43237, 43189, 43141, 43094, 43046, 42998, 42951, 42903, 42855, 42807, 42759, 42711, 42663, 42616, 42568, 42520, 42472, 42424, 42376, 42327, 42279, 42231, 42183, 42135, 42087, 42039, 41990, 41942, 41894, 41846, 41797, 41749, 41701, 41652, 41604, 41555, 41507, 41459, 41410, 41362, 41313, 41265, 41216, 41167, 41119, 41070, 41022, 40973, 40924, 40876, 40827, 40778, 40729, 40681, 40632, 40583, 40534, 40485, 40436, 40388, 40339, 40290, 40241, 40192, 40143, 40094, 40045, 39996, 39947, 39898, 39849, 39800, 39751, 39701, 39652, 39603, 39554, 39505, 39456, 39406, 39357, 39308, 39259, 39209, 39160, 39111, 39061, 39012, 38963, 38913, 38864, 38815, 38765, 38716, 38666, 38617, 38567, 38518, 38469, 38419, 38369, 38320, 38270, 38221, 38171, 38122, 38072, 38023, 37973, 37923, 37874, 37824, 37774, 37725, 37675, 37625, 37575, 37526, 37476, 37426, 37377, 37327, 37277, 37227, 37177, 37128, 37078, 37028, 36978, 36928, 36878, 36828, 36779, 36729, 36679, 36629, 36579, 36529, 36479, 36429, 36379, 36329, 36279, 36229, 36179, 36129, 36079, 36029, 35979, 35929, 35879, 35829, 35779, 35729, 35679, 35629, 35579, 35529, 35479, 35429, 35378, 35328, 35278, 35228, 35178, 35128, 35078, 35028, 34977, 34927, 34877, 34827, 34777, 34727, 34676, 34626, 34576, 34526, 34476, 34426, 34375, 34325, 34275, 34225, 34174, 34124, 34074, 34024, 33974, 33923, 33873, 33823, 33773, 33722, 33672, 33622, 33572, 33521, 33471, 33421, 33371, 33320, 33270, 33220, 33170, 33119, 33069, 33019, 32969, 32918, 32868, 32818,
		32768, 32717, 32667, 32617, 32566, 32516, 32466, 32416, 32365, 32315, 32265, 32215, 32164, 32114, 32064, 32014, 31963, 31913, 31863, 31813, 31762, 31712, 31662, 31612, 31561, 31511, 31461, 31411, 31361, 31310, 31260, 31210, 31160, 31109, 31059, 31009, 30959, 30909, 30859, 30808, 30758, 30708, 30658, 30608, 30558, 30507, 30457, 30407, 30357, 30307, 30257, 30207, 30157, 30106, 30056, 30006, 29956, 29906, 29856, 29806, 29756, 29706, 29656, 29606, 29556, 29506, 29456, 29406, 29356, 29306, 29256, 29206, 29156, 29106, 29056, 29006, 28956, 28906, 28856, 28806, 28756, 28707, 28657, 28607, 28557, 28507, 28457, 28407, 28358, 28308, 28258, 28208, 28158, 28109, 28059, 28009, 27960, 27910, 27860, 27810, 27761, 27711, 27661, 27612, 27562, 27512, 27463, 27413, 27364, 27314, 27265, 27215, 27166, 27116, 27066, 27017, 26968, 26918, 26869, 26819, 26770, 26720, 26671, 26622, 26572, 26523, 26474, 26424, 26375, 26326, 26276, 26227, 26178, 26129, 26079, 26030, 25981, 25932, 25883, 25834, 25784, 25735, 25686, 25637, 25588, 25539, 25490, 25441, 25392, 25343, 25294, 25245, 25196, 25147, 25099, 25050, 25001, 24952, 24903, 24854, 24806, 24757, 24708, 24659, 24611, 24562, 24513, 24465, 24416, 24368, 24319, 24270, 24222, 24173, 24125, 24076, 24028, 23980, 23931, 23883, 23834, 23786, 23738, 23689, 23641, 23593, 23545, 23496, 23448, 23400, 23352, 23304, 23256, 23208, 23159, 23111, 23063, 23015, 22967, 22919, 22872, 22824, 22776, 22728, 22680, 22632, 22584, 22537, 22489, 22441, 22394, 22346, 22298, 22251, 22203, 22155, 22108, 22060, 22013, 21965, 21918, 21871, 21823, 21776, 21728, 21681, 21634, 21587, 21539, 21492, 21445, 21398, 21351, 21304, 21257, 21209, 21162, 21115, 21068, 21022, 20975, 20928, 20881, 20834, 20787, 20741, 20694, 20647, 20600, 20554, 20507, 20460, 20414, 20367, 20321, 20274, 20228, 20181, 20135, 20089, 20042, 19996, 19950, 19904, 19857, 19811, 19765, 19719, 19673, 19627, 19581, 19535, 19489, 19443, 19397, 19351, 19305, 19259, 19214, 19168, 19122, 19076, 19031, 18985, 18940, 18894, 18849, 18803, 18758, 18712, 18667, 18621, 18576, 18531, 18486, 18440, 18395, 18350, 18305, 18260, 18215, 18170, 18125, 18080, 18035, 17990, 17945, 17900, 17856, 17811, 17766, 17721, 17677, 17632, 17588, 17543, 17499, 17454, 17410, 17365, 17321, 17277, 17232, 17188, 17144, 17100, 17056, 17012, 16968, 16924, 16880, 16836, 16792, 16748, 16704, 16660, 16616, 16573, 16529, 16485, 16442, 16398, 16355, 16311, 16268, 16224, 16181, 16138, 16094, 16051, 16008, 15965, 15922, 15879, 15835, 15792, 15750, 15707, 15664, 15621, 15578, 15535, 15493, 15450, 15407, 15365, 15322, 15279, 15237, 15195, 15152, 15110, 15067, 15025, 14983, 14941, 14899, 14856, 14814, 14772, 14730, 14688, 14647, 14605, 14563, 14521, 14479, 14438, 14396, 14354, 14313, 14271, 14230, 14188, 14147, 14106, 14064, 14023, 13982, 13941, 13900, 13859, 13818, 13777, 13736, 13695, 13654, 13613, 13572, 13532, 13491, 13450, 13410, 13369, 13329, 13288, 13248, 13208, 13167, 13127, 13087, 13047, 13007, 12966, 12926, 12886, 12847, 12807, 12767, 12727, 12687, 12648, 12608, 12568, 12529, 12489, 12450, 12410, 12371, 12332, 12292, 12253, 12214, 12175, 12136, 12097, 12058, 12019, 11980, 11941, 11902, 11864, 11825, 11786, 11748, 11709, 11671, 11632, 11594, 11556, 11517, 11479, 11441, 11403, 11365, 11327, 11289, 11251, 11213, 11175, 11137, 11099, 11062, 11024, 10987, 10949, 10912, 10874, 10837, 10799, 10762, 10725, 10688, 10651, 10614, 10577, 10540, 10503, 10466, 10429, 10392, 10356, 10319, 10282, 10246, 10209, 10173, 10137, 10100, 10064, 10028, 9992, 9956, 9919, 9883, 9848, 9812, 9776, 9740, 9704, 9669, 9633, 9597, 9562, 9526, 9491, 9456, 9420, 9385, 9350, 9315, 9280, 9245, 9210, 9175, 9140, 9105, 9070, 9036, 9001, 8967, 8932, 8898, 8863, 8829, 8794, 8760, 8726, 8692, 8658, 8624, 8590, 8556, 8522, 8488, 8455, 8421, 8387, 8354, 8320, 8287, 8253, 8220, 8187, 8154, 8121, 8087, 8054, 8021, 7989, 7956, 7923, 7890, 7857, 7825, 7792, 7760, 7727, 7695, 7663, 7630, 7598, 7566, 7534, 7502, 7470, 7438, 7406, 7374, 7342, 7311, 7279, 7248, 7216, 7185, 7153, 7122, 7091, 7060, 7028, 6997, 6966, 6935, 6904, 6874, 6843, 6812, 6781, 6751, 6720, 6690, 6660, 6629, 6599, 6569, 6539, 6508, 6478, 6448, 6418, 6389, 6359, 6329, 6299, 6270, 6240, 6211, 6181, 6152, 6123, 6094, 6064, 6035, 6006, 5977, 5948, 5920, 5891, 5862, 5833, 5805, 5776, 5748, 5719, 5691, 5663, 5635, 5606, 5578, 5550, 5522, 5494, 5467, 5439, 5411, 5383, 5356, 5328, 5301, 5274, 5246, 5219, 5192, 5165, 5138, 5111, 5084, 5057, 5030, 5003, 4977, 4950, 4924, 4897, 4871, 4844, 4818, 4792, 4766, 4740, 4714, 4688, 4662, 4636, 4610, 4585, 4559, 4533, 4508, 4483, 4457, 4432, 4407, 4382, 4357, 4332, 4307, 4282, 4257, 4232, 4208, 4183, 4158, 4134, 4109, 4085, 4061, 4037, 4013, 3988, 3964, 3941, 3917, 3893, 3869, 3845, 3822, 3798, 3775, 3752, 3728, 3705, 3682, 3659, 3636, 3613, 3590, 3567, 3544, 3521, 3499, 3476, 3454, 3431, 3409, 3387, 3364, 3342, 3320, 3298, 3276, 3254, 3233, 3211, 3189, 3168, 3146, 3125, 3103, 3082, 3061, 3039, 3018, 2997, 2976, 2955, 2935, 2914, 2893, 2873, 2852, 2832, 2811, 2791, 2771, 2750, 2730, 2710, 2690, 2670, 2650, 2631, 2611, 2591, 2572, 2552, 2533, 2514, 2494, 2475, 2456, 2437, 2418, 2399, 2380, 2361, 2343, 2324, 2305, 2287, 2269, 2250, 2232, 2214, 2196, 2178, 2160, 2142, 2124, 2106, 2088, 2071, 2053, 2036, 2018, 2001, 1984, 1967, 1949, 1932, 1915, 1899, 1882, 1865, 1848, 1832, 1815, 1799, 1782, 1766, 1750, 1734, 1717, 1701, 1686, 1670, 1654, 1638, 1622, 1607, 1591, 1576, 1561, 1545, 1530, 1515, 1500, 1485, 1470, 1455, 1440, 1426, 1411, 1396, 1382, 1368, 1353, 1339, 1325, 1311, 1297, 1283, 1269, 1255, 1241, 1228, 1214, 1200, 1187, 1174, 1160, 1147, 1134, 1121, 1108, 1095, 1082, 1069, 1057, 1044, 1031, 1019, 1007, 994, 982, 970, 958, 946, 934, 922, 910, 898, 887, 875, 864, 852, 841, 830, 818, 807, 796, 785, 774, 763, 753, 742, 731, 721, 710, 700, 690, 680, 669, 659, 649, 639, 630, 620, 610, 601, 591, 582, 572, 563, 554, 544, 535, 526, 517, 509, 500, 491, 482, 474, 465, 457, 449, 440, 432, 424, 416, 408, 400, 392, 385, 377, 370, 362, 355, 347, 340, 333, 326, 319, 312, 305, 298, 291, 285, 278, 272, 265, 259, 253, 246, 240, 234, 228, 222, 217, 211, 205, 200, 194, 189, 183, 178, 173, 168, 163, 158, 153, 148, 143, 139, 134, 130, 125, 121, 117, 112, 108, 104, 100, 96, 93, 89, 85, 82, 78, 75, 71, 68, 65, 62, 59, 56, 53, 50, 47, 45, 42, 39, 37, 35, 32, 30, 28, 26, 24, 22, 20, 19, 17, 15, 14, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 2, 1, 1, 1, 0, 0, 0,
		0, 0, 0, 0, 1, 1, 1, 2, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 14, 15, 17, 19, 20, 22, 24, 26, 28, 30, 32, 35, 37, 39, 42, 45, 47, 50, 53, 56, 59, 62, 65, 68, 71, 75, 78, 82, 85, 89, 93, 96, 100, 104, 108, 112, 117, 121, 125, 130, 134, 139, 143, 148, 153, 158, 163, 168, 173, 178, 183, 189, 194, 200, 205, 211, 217, 222, 228, 234, 240, 246, 253, 259, 265, 272, 278, 285, 291, 298, 305, 312, 319, 326, 333, 340, 347, 355, 362, 370, 377, 385, 392, 400, 408, 416, 424, 432, 440, 449, 457, 465, 474, 482, 491, 500, 509, 517, 526, 535, 544, 554, 563, 572, 582, 591, 601, 610, 620, 630, 639, 649, 659, 669, 680, 690, 700, 710, 721, 731, 742, 753, 763, 774, 785, 796, 807, 818, 830, 841, 852, 864, 875, 887, 898, 910, 922, 934, 946, 958, 970, 982, 994, 1007, 1019, 1031, 1044, 1057, 1069, 1082, 1095, 1108, 1121, 1134, 1147, 1160, 1174, 1187, 1200, 1214, 1228, 1241, 1255, 1269, 1283, 1297, 1311, 1325, 1339, 1353, 1368, 1382, 1396, 1411, 1426, 1440, 1455, 1470, 1485, 1500, 1515, 1530, 1545, 1561, 1576, 1591, 1607, 1622, 1638, 1654, 1670, 1686, 1701, 1717, 1734, 1750, 1766, 1782, 1799, 1815, 1832, 1848, 1865, 1882, 1899, 1915, 1932, 1949, 1967, 1984, 2001, 2018, 2036, 2053, 2071, 2088, 2106, 2124, 2142, 2160, 2178, 2196, 2214, 2232, 2250, 2269, 2287, 2305, 2324, 2343, 2361, 2380, 2399, 2418, 2437, 2456, 2475, 2494, 2514, 2533, 2552, 2572, 2591, 2611, 2631, 2650, 2670, 2690, 2710, 2730, 2750, 2771, 2791, 2811, 2832, 2852, 2873, 2893, 2914, 2935, 2955, 2976, 2997, 3018, 3039, 3061, 3082, 3103, 3125, 3146, 3168, 3189, 3211, 3233, 3254, 3276, 3298, 3320, 3342, 3364, 3387, 3409, 3431, 3454, 3476, 3499, 3521, 3544, 3567, 3590, 3613, 3636, 3659, 3682, 3705, 3728, 3752, 3775, 3798, 3822, 3845, 3869, 3893, 3917, 3941, 3964, 3988, 4013, 4037, 4061, 4085, 4109, 4134, 4158, 4183, 4208, 4232, 4257, 4282, 4307, 4332, 4357, 4382, 4407, 4432, 4457, 4483, 4508, 4533, 4559, 4585, 4610, 4636, 4662, 4688, 4714, 4740, 4766, 4792, 4818, 4844, 4871, 4897, 4924, 4950, 4977, 5003, 5030, 5057, 5084, 5111, 5138, 5165, 5192, 5219, 5246, 5274, 5301, 5328, 5356, 5383, 5411, 5439, 5467, 5494, 5522, 5550, 5578, 5606, 5635, 5663, 5691, 5719, 5748, 5776, 5805, 5833, 5862, 5891, 5920, 5948, 5977, 6006, 6035, 6064, 6094, 6123, 6152, 6181, 6211, 6240, 6270, 6299, 6329, 6359, 6389, 6418, 6448, 6478, 6508, 6539, 6569, 6599, 6629, 6660, 6690, 6720, 6751, 6781, 6812, 6843, 6874, 6904, 6935, 6966, 6997, 7028, 7060, 7091, 7122, 7153, 7185, 7216, 7248, 7279, 7311, 7342, 7374, 7406, 7438, 7470, 7502, 7534, 7566, 7598, 7630, 7663, 7695, 7727, 7760, 7792, 7825, 7857, 7890, 7923, 7956, 7989, 8021, 8054, 8087, 8121, 8154, 8187, 8220, 8253, 8287, 8320, 8354, 8387, 8421, 8455, 8488, 8522, 8556, 8590, 8624, 8658, 8692, 8726, 8760, 8794, 8829, 8863, 8898, 8932, 8967, 9001, 9036, 9070, 9105, 9140, 9175, 9210, 9245, 9280, 9315, 9350, 9385, 9420, 9456, 9491, 9526, 9562, 9597, 9633, 9669, 9704, 9740, 9776, 9812, 9848, 9883, 9919, 9956, 9992, 10028, 10064, 10100, 10137, 10173, 10209, 10246, 10282, 10319, 10356, 10392, 10429, 10466, 10503, 10540, 10577, 10614, 10651, 10688, 10725, 10762, 10799, 10837, 10874, 10912, 10949, 10987, 11024, 11062, 11099, 11137, 11175, 11213, 11251, 11289, 11327, 11365, 11403, 11441, 11479, 11517, 11556, 11594, 11632, 11671, 11709, 11748, 11786, 11825, 11864, 11902, 11941, 11980, 12019, 12058, 12097, 12136, 12175, 12214, 12253, 12292, 12332, 12371, 12410, 12450, 12489, 12529, 12568, 12608, 12648, 12687, 12727, 12767, 12807, 12847, 12886, 12926, 12966, 13007, 13047, 13087, 13127, 13167, 13208, 13248, 13288, 13329, 13369, 13410, 13450, 13491, 13532, 13572, 13613, 13654, 13695, 13736, 13777, 13818, 13859, 13900, 13941, 13982, 14023, 14064, 14106, 14147, 14188, 14230, 14271, 14313, 14354, 14396, 14438, 14479, 14521, 14563, 14605, 14647, 14688, 14730, 14772, 14814, 14856, 14899, 14941, 14983, 15025, 15067, 15110, 15152, 15195, 15237, 15279, 15322, 15365, 15407, 15450, 15493, 15535, 15578, 15621, 15664, 15707, 15750, 15792, 15835, 15879, 15922, 15965, 16008, 16051, 16094, 16138, 16181, 16224, 16268, 16311, 16355, 16398, 16442, 16485, 16529, 16573, 16616, 16660, 16704, 16748, 16792, 16836, 16880, 16924, 16968, 17012, 17056, 17100, 17144, 17188, 17232, 17277, 17321, 17365, 17410, 17454, 17499, 17543, 17588, 17632, 17677, 17721, 17766, 17811, 17856, 17900, 17945, 17990, 18035, 18080, 18125, 18170, 18215, 18260, 18305, 18350, 18395, 18440, 18486, 18531, 18576, 18621, 18667, 18712, 18758, 18803, 18849, 18894, 18940, 18985, 19031, 19076, 19122, 19168, 19214, 19259, 19305, 19351, 19397, 19443, 19489, 19535, 19581, 19627, 19673, 19719, 19765, 19811, 19857, 19904, 19950, 19996, 20042, 20089, 20135, 20181, 20228, 20274, 20321, 20367, 20414, 20460, 20507, 20554, 20600, 20647, 20694, 20741, 20787, 20834, 20881, 20928, 20975, 21022, 21068, 21115, 21162, 21209, 21257, 21304, 21351, 21398, 21445, 21492, 21539, 21587, 21634, 21681, 21728, 21776, 21823, 21871, 21918, 21965, 22013, 22060, 22108, 22155, 22203, 22251, 22298, 22346, 22394, 22441, 22489, 22537, 22584, 22632, 22680, 22728, 22776, 22824, 22872, 22919, 22967, 23015, 23063, 23111, 23159, 23208, 23256, 23304, 23352, 23400, 23448, 23496, 23545, 23593, 23641, 23689, 23738, 23786, 23834, 23883, 23931, 23980, 24028, 24076, 24125, 24173, 24222, 24270, 24319, 24368, 24416, 24465, 24513, 24562, 24611, 24659, 24708, 24757, 24806, 24854, 24903, 24952, 25001, 25050, 25099, 25147, 25196, 25245, 25294, 25343, 25392, 25441, 25490, 25539, 25588, 25637, 25686, 25735, 25784, 25834, 25883, 25932, 25981, 26030, 26079, 26129, 26178, 26227, 26276, 26326, 26375, 26424, 26474, 26523, 26572, 26622, 26671, 26720, 26770, 26819, 26869, 26918, 26968, 27017, 27066, 27116, 27166, 27215, 27265, 27314, 27364, 27413, 27463, 27512, 27562, 27612, 27661, 27711, 27761, 27810, 27860, 27910, 27960, 28009, 28059, 28109, 28158, 28208, 28258, 28308, 28358, 28407, 28457, 28507, 28557, 28607, 28657, 28707, 28756, 28806, 28856, 28906, 28956, 29006, 29056, 29106, 29156, 29206, 29256, 29306, 29356, 29406, 29456, 29506, 29556, 29606, 29656, 29706, 29756, 29806, 29856, 29906, 29956, 30006, 30056, 30106, 30157, 30207, 30257, 30307, 30357, 30407, 30457, 30507, 30558, 30608, 30658, 30708, 30758, 30808, 30859, 30909, 30959, 31009, 31059, 31109, 31160, 31210, 31260, 31310, 31361, 31411, 31461, 31511, 31561, 31612, 31662, 31712, 31762, 31813, 31863, 31913, 31963, 32014, 32064, 32114, 32164, 32215, 32265, 32315, 32365, 32416, 32466, 32516, 32566, 32617, 32667, 32717
	};
public:
	static dds_value_t lookup(uint32_t x)
	{
		return lookup_table[x >> 20];
	}
};

template <class LookupT>
struct poly_channel_t {
	uint32_t phase_acc;
	uint32_t phase_inc;
	void reset(uint32_t inc)
	{
		phase_acc = 0;
		phase_inc = inc;
	}

	dds_value_t tick()
	{
		const auto r = LookupT::lookup(phase_acc);
		phase_acc += phase_inc;
		return r;
	}
};
poly_channel_t<lookup_square_t> ch_sq;
poly_channel_t<lookup_sin12_t> ch_sin;



typedef uint32_t queue_item_t;

queue_item_t queue_item_encode(notes::sym_t n, notes::duration_t d)
{
	return static_cast<uint32_t>(n) | (static_cast<uint32_t>(d) << 8);
}

void queue_item_decode(queue_item_t item, notes::sym_t& n, notes::duration_t& d)
{
	n = static_cast<notes::sym_t>(item & 0xff);
	d = static_cast<notes::duration_t>(item >> 8);
}


void player::enqueue_note(QueueHandle_t queue_handle, notes::sym_t n, notes::duration_t d)
{
	const queue_item_t item = queue_item_encode(n, d);
	xQueueSend(queue_handle, &item, 0);
}

void player::set_instrument_sq()
{
	g_def_instrument = sq;
}

void player::set_instrument_sin()
{
	g_def_instrument = sin;
}


struct queue_data_t {
	std::array<queue_item_t, 16> buffer;
	StaticQueue_t q;
} queue_data;

QueueHandle_t player::create_queue()
{
	return xQueueCreateStatic(
		queue_data.buffer.size(),
		sizeof(queue_item_t),
		reinterpret_cast<uint8_t*>(queue_data.buffer.data()),
		&queue_data.q
	);
}


struct play_task_data_t {
	std::array<StackType_t, 128> stack;
	TaskHandle_t task_handle = nullptr;
	StaticTask_t task_buffer;

	QueueHandle_t arg_queue_handle = nullptr;
} play_task_data;


#define TIM_DAC TIM6
const stm32_lib::gpio::gpio_pin_t pin_led_green(GPIOB, 3);
volatile bool led_st = false;
void toggle_led()
{
	const bool s = led_st;
	stm32_lib::gpio::set_state(pin_led_green, s);
	led_st = !s;
}
volatile uint32_t cnt = 0;

extern "C" __attribute__ ((interrupt)) void IntHandler_Timer6()
{
	const auto sr = TIM_DAC->SR;
	if (!(sr & TIM_SR_UIF)) {
		return;
	}

	dds_value_t v;
	switch (g_instrument) {
		case sin:
			v = ch_sin.tick();
			break;
		case sq:
			v = ch_sq.tick();
			break;
		default:
			TIM_DAC->SR = sr & ~TIM_SR_UIF;
			stm32_lib::gpio::set_state(pin_led_green, false);
			return;
	}
	DAC->DHR12R1 = v >> 4; // MSB 16bit -> 12bit

	TIM_DAC->SR = sr & ~TIM_SR_UIF;

	{
		const uint32_t c = cnt;
		if (c % 1000 == 0) {
			toggle_led();
		}
		cnt = c + 1;
	}

}


#define CLOCK_SPEED configCPU_CLOCK_HZ

#define TIM_DAC TIM6
void dac_init()
{
	TIM_DAC->CR1 = 0;
	TIM_DAC->DIER |= TIM_DIER_UIE;
	TIM_DAC->PSC = 0;
	TIM_DAC->ARR = uint32_t(CLOCK_SPEED)/DDS_FREQ - 1;
	TIM_DAC->CR1 = TIM_CR1_CEN;
	NVIC_SetPriority(TIM6_IRQn, 3); // TODO
	NVIC_EnableIRQ(TIM6_IRQn);

	stm32_lib::gpio::set_mode_output_analog(pin_dac);

	//DAC->CR = 0;
	DAC->CR = DAC_CR_EN1_Msk;
}

void play_note(notes::sym_t n, notes::duration_t d)
{
	const auto fade = configTICK_RATE_HZ/128;

	g_instrument = none;
	vTaskDelay(1);

	const uint32_t inc = (uint64_t(1ULL << 32) * uint64_t(freq100[n])) / uint64_t(DDS_FREQ_MUL_100);
	ch_sin.reset(inc);
	ch_sq.reset(inc);

	g_instrument = g_def_instrument;
	vTaskDelay(configTICK_RATE_HZ/64*d - fade);
	g_instrument = none;

	vTaskDelay(fade);
}


void play_task_function(void*)
{
	for(;;) {
		queue_item_t item;
		if (xQueueReceive(play_task_data.arg_queue_handle, &item, configTICK_RATE_HZ/*1sec*/) == pdTRUE) {
			notes::sym_t n;
			notes::duration_t d;
			queue_item_decode(item, n, d);
			play_note(n, d);
		}
	}
}


void player::create_task(const char* task_name, UBaseType_t prio, QueueHandle_t queue_handle)
{
	dac_init();
	play_task_data.arg_queue_handle = queue_handle;
	xTaskCreateStatic(
		&play_task_function,
		task_name,
		play_task_data.stack.size(),
		nullptr,
		prio,
		play_task_data.stack.data(),
		&play_task_data.task_buffer
	);
}

